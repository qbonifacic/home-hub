<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Home Hub{% endblock %} â€” Bonifacic</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
  <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
  {% if current_user.is_authenticated %}
  <nav class="navbar navbar-expand-md border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="{{ url_for('dashboard.index') }}">
        <i class="bi bi-house-heart-fill"></i> Home Hub
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link {% if request.endpoint and request.endpoint.startswith('dashboard') %}active{% endif %}" href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint and request.endpoint.startswith('meals') %}active{% endif %}" href="{{ url_for('meals.index') }}">Meals</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint and request.endpoint.startswith('chores') %}active{% endif %}" href="{{ url_for('chores.index') }}">Chores</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint and request.endpoint.startswith('shopping') %}active{% endif %}" href="{{ url_for('shopping.index') }}">Shopping</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint and request.endpoint.startswith('schedule') %}active{% endif %}" href="{{ url_for('schedule.index') }}">Schedule</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint and request.endpoint.startswith('reminders') %}active{% endif %}" href="{{ url_for('reminders.index') }}">Reminders</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint and request.endpoint.startswith('cards') %}active{% endif %}" href="{{ url_for('cards.index') }}">Cards</a></li>
          <li class="nav-item"><a class="nav-link {% if request.endpoint and request.endpoint.startswith('health') %}active{% endif %}" href="{{ url_for('health.index') }}">Goals</a></li>
        </ul>
        <span class="navbar-text me-3">{{ current_user.id | title }}</span>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('auth.logout') }}">Logout</a>
      </div>
    </div>
  </nav>
  {% endif %}

  {% if current_user.is_authenticated %}
  <!-- Q Chat Bar (always visible below navbar) -->
  <div id="q-chat-bar" style="background:#0d0d1a;border-bottom:1px solid #2a2a3e;padding:8px 16px;">
    <div style="max-width:900px;margin:0 auto;">
      <!-- Collapsed: single-line input -->
      <div id="q-chat-collapsed" style="display:flex;align-items:center;gap:10px;">
        <span style="color:#6c63ff;font-size:18px;">ðŸ¤–</span>
        <input id="chat-input" type="text" placeholder="Ask Q to make changes â€” e.g. 'Mark vacuuming done' or 'What's for dinner?'"
          style="flex:1;background:#1a1a2e;border:1px solid #333;border-radius:8px;padding:7px 14px;color:#e0e0e0;outline:none;font-size:14px;"
          onfocus="expandChat()" onkeydown="if(event.key==='Enter')sendChat()">
        <button onclick="sendChat()" style="background:#6c63ff;border:none;border-radius:8px;padding:7px 18px;color:#fff;cursor:pointer;font-weight:600;font-size:14px;white-space:nowrap;">Send</button>
      </div>
      <!-- Expanded: message history -->
      <div id="chat-messages" style="display:none;max-height:260px;overflow-y:auto;margin-top:10px;flex-direction:column;gap:8px;padding:4px 0;"></div>
    </div>
  </div>
  {% endif %}

  <main class="container-fluid py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
      <div class="alert alert-{{ cat }} alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %}
    {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  {% if current_user.is_authenticated %}
  <script>
  var chatExpanded = false;
  function expandChat(){
    if(chatExpanded) return;
    chatExpanded = true;
    var msgs = document.getElementById('chat-messages');
    msgs.style.display = 'flex';
  }
  function addMsg(text, role){
    expandChat();
    var d = document.getElementById('chat-messages');
    var m = document.createElement('div');
    m.style.cssText = 'max-width:85%;padding:7px 12px;border-radius:10px;font-size:14px;line-height:1.4;word-wrap:break-word;white-space:pre-wrap;';
    if(role === 'user'){
      m.style.cssText += 'align-self:flex-end;background:#6c63ff;color:#fff;margin-left:auto;';
    } else {
      m.style.cssText += 'align-self:flex-start;background:#1e1e35;color:#e0e0e0;border:1px solid #333;';
    }
    m.textContent = text;
    d.appendChild(m);
    d.scrollTop = d.scrollHeight;
    return m;
  }
  function sendChat(){
    var inp = document.getElementById('chat-input');
    var msg = inp.value.trim();
    if(!msg) return;
    inp.value = '';
    addMsg(msg, 'user');
    var think = addMsg('Thinkingâ€¦', 'ai');
    var csrfToken = document.querySelector('meta[name=csrf-token]');
    var headers = {'Content-Type':'application/json'};
    if(csrfToken) headers['X-CSRFToken'] = csrfToken.content;
    fetch('/api/chat', {method:'POST', headers:headers, body:JSON.stringify({message:msg})})
      .then(function(r){ return r.json(); })
      .then(function(d){ think.textContent = d.response || d.error || 'No response'; })
      .catch(function(e){ think.textContent = 'Error: ' + e.message; });
  }
  </script>
  {% endif %}
</body>
</html>
